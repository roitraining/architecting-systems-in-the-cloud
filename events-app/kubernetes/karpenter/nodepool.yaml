apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: default
spec:
  # Template defines the node properties
  template:
    spec:
      # Requirements for node selection
      requirements:
        # Instance types - allow a range of instance types
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]  # Use on-demand instances (can also use "spot" for cost savings)
        
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]  # Architecture
        
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values: ["t", "m", "c"]  # Allow t, m, and c instance families
        
        - key: karpenter.k8s.aws/instance-generation
          operator: Gt
          values: ["2"]  # Use generation 3 and above (t3, m5, c5, etc.)
      
      # Reference to EC2NodeClass
      nodeClassRef:
        name: default
      
      # Taints can be used to control pod placement
      # taints:
      #   - key: example.com/special
      #     value: "true"
      #     effect: NoSchedule
  
  # Limits define the maximum resources Karpenter can provision
  limits:
    cpu: "100"      # Maximum 100 vCPUs across all nodes
    memory: 200Gi   # Maximum 200 GiB memory across all nodes
  
  # Disruption controls when Karpenter can remove nodes
  disruption:
    # Consolidation removes underutilized nodes
    consolidationPolicy: WhenUnderutilized
    
    # How long to wait before considering a node for consolidation
    consolidateAfter: 30s
    
    # Expiration removes nodes after a certain time (optional)
    # expireAfter: 720h  # 30 days
  
  # Weight determines priority when multiple NodePools match
  weight: 10
