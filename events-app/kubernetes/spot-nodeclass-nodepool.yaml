apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: spot-compute
spec:
  amiFamily: AL2
  role: KarpenterNodeRole-CLUSTER_NAME  # Replace with your actual node role
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: CLUSTER_NAME  # Replace with your cluster name
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: CLUSTER_NAME  # Replace with your cluster name
  tags:
    Name: spot-compute-node
    Environment: production
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: spot-compute
spec:
  template:
    spec:
      nodeClassRef:
        name: spot-compute
      requirements:
        # Instance families: C4, C5, and all M families
        - key: karpenter.k8s.aws/instance-family
          operator: In
          values: ["c4", "c5", "c5a", "c5ad", "c5d", "c5n", "m4", "m5", "m5a", "m5ad", "m5d", "m5dn", "m5n", "m5zn", "m6a", "m6i", "m6id", "m6idn", "m6in", "m6g", "m6gd"]
        # Exclude small sizes
        - key: karpenter.k8s.aws/instance-size
          operator: NotIn
          values: ["nano", "micro", "small"]
        # Use spot instances
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["spot"]
        # Architecture
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        # OS
        - key: kubernetes.io/os
          operator: In
          values: ["linux"]
      # Taints to ensure only pods that tolerate spot instances are scheduled
      taints:
        - key: spot
          value: "true"
          effect: NoSchedule
  # Resource limits for this node pool
  limits:
    cpu: 1000
    memory: 1000Gi
  # Disruption settings for spot instances
  disruption:
    consolidationPolicy: WhenUnderutilized
    expireAfter: 720h  # 30 days
